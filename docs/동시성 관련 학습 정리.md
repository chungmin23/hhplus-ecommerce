## 동시성 제어

### 1) 낙관적 락

- 데이터 변경 전 버전 정보 또는 타임스탬프를 저장합니다
- 업데이트시 현재 데이터의 버전 정보를 확인해 일치하는 경우에만 작업을 수행 합니다
- 충동이 발생하면 해당 트랜잭션을 롤백하고 재시도 로직을 추가합니다



1. 사용처
    - 충돌이 드문 상황과 읽기 작업이 많은 경우 적합합니다
    - ex) 읽기 위주의 api, 사용자별 자원 관리

2. 장점
    - 성능이 우수하고 교착상태가 발생하지 않습니다
    - 락을 사용하지 않으므로 다른 작업이 지연되지 않습니다

3. 단점
    - 충돌빈도가 높은 경우 성능 저하가 발생할 수 있습니다
    - 재시도 로직이 필요하므로 구현 복잡성이 증가할수 있습니다



### 2) 비관적 락

- 데이터 수정전 다른 트랜잭션이 해당 데이터에 접근하지 못하도록 SELECT ....FOR UPDATE를 사용해 락을 설정 합니다
- 락이 설정된 데이터는 해당 트랜잭션이 완료되기 전까지 읽기/수정이 제한 됩니다

1. 사용처

    - 데이터 충돌 가능성이 높고 데이터 일관성이 중요한 경우 사용합니다
    - ex) 재고차감, 은행 계과의 잔액 관리

2. 장점

    - 데이터 무결성이 보장되고 구현이 비교적 단순합니다
    - 충돌 가능성이 높은 경우에도 안정적으로 데이터 보호가 가능합니다

3. 단점

    - 교착상태가 발생할 위험이 있으며, 대기 시간이 증가해 성능 저하가 일어날수 있습니다
    - 락이 설정된 데이터가 많은 경우 시스템 자원에 큰 부담을 줄수 있습니다



### 3) Redis 분산락

- redis의 setnx 명령어를 사용하여 락을 설정하고 락의 유효기간을 설정해 자동해제를 보장합니다
- Redlock 알고리즘을 사용해  다중 redis 노드 환경에서도 락의 일관성을 유지할수 있습니다



1. 사용처

    - 분산환경, 대규모 트래픽 상황 에 상황을 처리할때 적합합니다
    - ex) 선착순 쿠폰 발급, 실시간 이벤트 관리

2. 장점

    - 분산환경에서 효과적으로 락을 관리할수 있습니다
    - redis의 고성능 처리 속도를 활용해 높은 동시 요청을 처리할수 있습니다

3. 단점

    - redis 서버 장애를 겪는 경우 락이 풀리지 않는 문제가 발생할수 있으므로 별도 장애 복구 로직이 필요합니다
    - 락의 유효기간 설정을 신중히 하지 않으면 예상치 못한 동작이 발생할수 있습니다



## 이커머스에서 경우에 따라 동시성 적용 방식



#### 1) 상품의 재고 차감 및 복원

- 비관적락
  - 재고가 적고 동시요청이 많아 경쟁이 심한 경우
  - ex) 인기상품 또는 한정판 상품

- 낙관적락
    - 재고 수량이 충분히 많아 동시성 충돌 가능성이 낮은 경우
    - ex) 일반 상품

[선택] 
비관적락 - 인기 상품인 경우 동시 요청이 많을 수있기 때문에 선택을 하였습니다



#### 2) 유저의 포인트 잔액 관리

- 낙관적락 
    - 포인트는 개인별로 관리되기 때문에 동시 요청이 많지 않을거라 예상함

[선택] 
낙관적락 - 유저 개인의 포인트이기 때문에 동시요청을 많지 않을거라 생각하여 성능 과 동시성을 모두 고려하여 낙관적락을 선택하였습니다



#### 3) 선착순 쿠폰 발급

-  redis
    - 대규모 트래픽을 처리할수 있는 redis 를 활용하여 ROCK을 관리합니다

[선택] 
redis - 선착순 쿠폰 발급은 수천 건 이상의 동시 요청이 발생할 가능성이 크므로 redis를 사용을 선택했습니다


## 정리

| **방식**             | **구현 복잡도** | **성능**                  | **효율성**              | **적합한 시나리오**                              |
| -------------------- | --------------- | ------------------------- | ----------------------- | ------------------------------------------------ |
| **Optimistic Lock**  | 중간            | 좋음                      | 충돌이 적으면 효율적    | 충돌이 드문 환경, 읽기 위주의 작업               |
| **Pessimistic Lock** | 낮음~중간       | 낮음 (잠금 비용)          | 충돌 빈도가 높으면 적합 | 데이터 충돌 빈도가 높은 환경                     |
| **Redis 분산 락**    | 높음            | 네트워크 환경에 따라 다름 | 분산환경에 효과적       | 여러 인스턴스가 동일 자원을 사용하는 분산 시스템 |

